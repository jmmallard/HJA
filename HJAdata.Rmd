---
title: "HJAdata"
author: "Mallard"
date: "10/24/2022"
output: html_document
---
Outputs of this script are:
- allData: combined Q and met daily data
- allQData: daily Q data from WS1,2,3,10
- met: daily all met variables including precip, temp, vpd (max min mean of the latter two)
- metXXXX: daily individual met variables 
- XXXraw: loaded csv data from HJA data portal. No restructuring or filtering


Loading packages and input data
```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(zoo)
library(climwin)
library(plotly)
```

Input data catalog:
- HF00402: Flow data, daily runoff in (normalized to area)
- MS00103: Precip data, mm
- HT00401: Temp @ gauges, deg C [per SteveW likely to be lower quality temp enclosures]
- MS00101: Daily (min/max/mean) Temp @ met stations, deg C
- MS00108: vpd (min/max/mean) @ met stations, mb
```{r inputData, echo=FALSE, message=FALSE}
qRaw <- read.csv("Data/HF00402_v12.csv")
precipRaw <- read.csv("Data/MS00103_v8.csv")
tempRaw <- read.csv("Data/MS00101_v9.csv")
vpdRaw <- read.csv("Data/MS00108_v9.csv")

```

Figuring out extents of data at met stations. 
```{r metDataExtent, echo=FALSE, message=FALSE}
metSiteLength <- precipRaw %>% 
  group_by(SITECODE) %>% 
  summarise(
    timeStart = min(DATE),
    timeEnd = max(DATE)
  ) %>% 
  arrange(timeStart)

metSiteLength
```

Per Steve Wondzell PRIMET is the station to use for precip, CS2MET is likely a bit too overgrown and may be undercatching. PRIMET also site to use for vpd and temp per Chris Daly.

Filter and restructure met:
- Only one site
- Combine temp, vpd, and precip
- Filtering:
  - Temp
    - Sensor heights = 1.5 m.
    - Probe 5 and 6, and the brief period between 5 and 6 with no measurements use probe 4
  - Vpd
    - Sensor height = 1.5 m
    - Probe 5 or probe 4 after 2000-5-29
```{r metData, echo=FALSE, message=FALSE}
metPrecip <- precipRaw %>% 
  filter(SITECODE == "PRIMET") %>% 
  select(DATE,PRECIP_TOT_DAY) %>% 
  rename(precip = PRECIP_TOT_DAY) %>% 
  mutate(DATE = as_date(DATE))

metTemp <- tempRaw %>% 
  filter(SITECODE == "PRIMET") %>% 
  mutate(DATE = as_date(DATE)) %>% 
  filter(HEIGHT == 150) %>% 
  filter(!(PROBE_CODE == "AIRPRI03")) %>% 
  filter(PROBE_CODE %in% c("AIRPRI06", "AIRPRI05") | 
           (PROBE_CODE == "AIRPRI04" & between(DATE, as.Date("2004-6-15"), as.Date("2004-6-25")))) %>% 
  select(DATE,AIRTEMP_MEAN_DAY,AIRTEMP_MAX_DAY,AIRTEMP_MIN_DAY) %>% 
  rename(meanTemp = AIRTEMP_MEAN_DAY, maxTemp = AIRTEMP_MAX_DAY, minTemp = AIRTEMP_MIN_DAY)

metVpd <- vpdRaw %>% 
  filter(SITECODE == "PRIMET") %>% 
  mutate(DATE = as_date(DATE)) %>% 
  filter(HEIGHT == 150) %>% 
  filter((PROBE_CODE == "VPDPRI05") |
           ((PROBE_CODE == "VPDPRI04") & (DATE > as_date("2000-05-29")))
           ) %>% 
  select(DATE,VPD_MEAN_DAY,VPD_MAX_DAY,VPD_MIN_DAY) %>% 
  rename(meanVpd = VPD_MEAN_DAY, maxVpd = VPD_MAX_DAY, minVpd = VPD_MIN_DAY)
  

#Create a list of these data frames and then use reduce to sequentially do a full join
metList <- list(metPrecip, metTemp, metVpd)

met <- metList %>% 
  reduce(full_join, by = "DATE")

rm(metList) #Cleanup environment
```

Now lets put some datasets together for multiple watersheds (including WS1)
- WSs 1,2,3,10
- Total Q (in inches), rather than mean, max, min
- Convert DATE from character to date format
- Convert inches to mm
- Reformat as a wide table
- Set dates past 2022 back to 20th century (caused by 2 digit dates in raw data)
- Reduce to common days b/n met and q, but not all common days for watersheds
- Add water year column
- Merge with "met" variable from "metData" chunk to record length of met data
  - This adds precip, temp (mean, max, min), and vpd (mean, max, min)
```{r allWSdata}
#Q data
allQData <- qRaw %>% 
  filter(SITECODE %in% c("GSWS01","GSWS02","GSWS03","GSWS10")) %>% 
  select(DATE,TOTAL_Q_AREA,SITECODE) %>% 
  rename(runoff = TOTAL_Q_AREA) %>% 
  mutate(DATE = mdy(DATE)) %>% 
  mutate(runoff = runoff * 25.4) %>% 
  pivot_wider(names_from = SITECODE,values_from = runoff) %>% 
  rename(WS1 = GSWS01,
         WS2 = GSWS02,
         WS3 = GSWS03,
         WS10 = GSWS10) %>% 
  mutate(DATE = if_else(year(DATE)>2022,DATE-years(100),DATE)) #ymd function has trouble with 2 digit years
  
#Merge with met data, add WY column
allData <- full_join(met, allQData, by='DATE') %>%
  mutate(yr = year(DATE), mn = month(DATE)) %>%
  mutate(WY = ifelse(mn > 9, yr + 1, yr)) %>%
  select(-c(yr,mn))
```

