---
title: "HJA_OpenET_WB"
output: html_notebook
---

Load packages
```{r LoadPackages}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(zoo)
library(climwin)
library(plotly)
library(imputeTS)
library(ggpubr)
library(ggthemes)
library(modelr)
```

OpenET data
```{r LoadOpenETData}
WS1_OpenET_raw <- read.csv("Data/OpenET/WS1_OpenET_Cum.csv")
WS2_OpenET_raw <- read.csv("Data/OpenET/WS2_OpenET_Cum.csv")
WS3_OpenET_raw <- read.csv("Data/OpenET/WS3_OpenET_Cum.csv")
All_OpenET_raw <- read.csv("Data/OpenET/All_WS_Summary.csv")
WS1Rip_OpenET_raw <- read.csv("Data/OpenET/WS1Rip_OpenET_raw.csv")
WS3Young_OpenET_raw <- read.csv("Data/OpenET/WS3Young_OpenET_raw.csv")
WS3Old_OpenET_raw <- read.csv("Data/OpenET/WS3Old_OpenET_raw.csv")

```

Function to restructure OpenET cumulative output data and convert to monthly
```{r RestructureOpenETfxn}
open_et_cum <- function(csv){
  csv %>% 
  gather(Year, ET, c(2,4,6,8,10,12)) %>%
  select(Category, Year, ET) %>%
  mutate(Year = as.numeric(str_sub(Year, -4, -1))) %>%
  mutate(Month = rep(1:12, times = 6)) %>%
  mutate(DATE = make_date(year = Year, month = Month, day = 1)) %>%
  select(DATE, ET) %>% 
  mutate(ET = case_when(month(DATE) == 1 ~ ET,
                        month(DATE) != 1 ~ ET - lag(ET, n = 1)))
}
```

Restructure data to be continuous long time series using function above and convert to monthly from cumulative
```{r RestructureOpenET}
WS1_All_OET <- open_et_cum(WS1_OpenET_raw)
WS2_All_OET <- open_et_cum(WS2_OpenET_raw)
WS3_All_OET <- open_et_cum(WS3_OpenET_raw)
WS1_Rip_OET <- open_et_cum(WS1Rip_OpenET_raw)
WS3_Young_OET <- open_et_cum(WS3Young_OpenET_raw)
WS3_Old_OET <- open_et_cum(WS3Old_OpenET_raw)
```

Watershed water balance
```{r WatershedWB}
WSAnnData <- allData %>% 
  select(DATE, precip, WS1, WS2, WS3, WY) %>% 
  filter(between(WY, 1980, 2018)) %>% 
  group_by(WY) %>% 
  summarize(annP = sum(precip, na.rm = TRUE),
            annWS1 = sum(WS1, na.rm = TRUE),
            annWS2 = sum(WS2, na.rm = TRUE),
            annWS3 = sum(WS3, na.rm = TRUE)) %>% 
  mutate(WS1res = annP - annWS1,
         WS2res = annP - annWS2,
         WS3res = annP - annWS3)

```

Some plots of above
```{r WB_Plots}
#Combine OpenET and WB residual data into one dataframe
All_OpenET <- All_OpenET_raw %>% 
  select(WY = Year, 
         WS = WS,
         ET = AnnET) %>% 
  mutate(WS = case_when(WS == 1 ~ "WS1_OET",
                        WS == 2 ~ "WS2_OET",
                        WS == 3 ~ "WS3_OET"))

WB_both <- WSAnnData %>% 
  select(WY, WS1res, WS2res, WS3res) %>% 
  rename(WS1 = WS1res,
         WS2 = WS2res,
         WS3 = WS3res) %>% 
  gather(WS, ET, WS1, WS2, WS3) %>% 
  bind_rows(All_OpenET) %>% 
  filter(WY >= 1999)

#Time series of residuals and OpenET
WBplot <- WB_both %>% 
  ggplot(aes(x = WY, y = ET, color = WS)) +
    geom_point() + xlab("Year") + ylab("P - Q or OpenET") 
  
print(WBplot)

#Summaries in box plots
WB_both_groups <- WB_both %>% 
  mutate(Est = case_when(WS %in% c("WS1", "WS2", "WS3") ~ "Res",
                         TRUE ~ "OET")) %>% 
  mutate(WS = case_when(WS == "WS1_OET" ~ "WS1",
                        WS == "WS2_OET" ~ "WS2",
                        WS == "WS3_OET" ~ "WS3",
                        TRUE ~ WS))

WBboxplot <- ggplot(WB_both_groups, aes(x = WS, y = ET, fill = Est)) +
  geom_boxplot()

print(WBboxplot)

```

Playing around with the residual plotted in box plot above.
Using AllData watershed data and WSX_All_OET
```{r WBresidual}


```


Compare ET between riparian and total WS1
```{r Riparian Comparison}
WS1_Comp_OET <- WS1_All_OET %>% 
  rename(All = ET) %>% 
  merge(WS1_Rip_OET) %>% 
  rename(Rip = ET) %>% 
  drop_na() %>% 
  mutate(Diff = All - Rip,
         DiffPer = 100 * (All - Rip)/All)

#Over the whole time series
WS1_Comp_OET_TS <- WS1_Comp_OET %>% 
  ggplot(aes(x = DATE, y = Diff)) +
    geom_point() +
    xlab("DATE") + ylab("Diff ET (mm or %)") + ggtitle("WS1 All ET - WS1 Riparian ET")

#Looking at monthly summaries
WS1_Comp_OET_ByMonth <- WS1_Comp_OET %>% 
  mutate(Month = month(DATE)) %>% 
  group_by(Month) %>% 
  summarise(AllMon = mean(All),
            RipMon = mean(Rip)) %>% 
  ungroup() %>% 
  mutate(DiffMon = AllMon - RipMon,
         DiffPerMon = 100 * (AllMon - RipMon)/AllMon) %>% 
  ggplot(aes(x = Month, y = DiffPerMon)) +
    geom_point() +
    xlab("Month") + ylab("Diff ET (mm or %)") + ggtitle("WS1 All ET - WS1 Riparian ET")

#Plots
print(WS1_Comp_OET_TS)
ggplotly(WS1_Comp_OET_TS)
print(WS1_Comp_OET_ByMonth)
ggplotly(WS1_Comp_OET_ByMonth)
```

Compare time series of ET from OpenET derived from adjacent, same aspect patches of old and young growth forest
```{r OldYoungWS3Comparison}
WS3_Comp_OET <- WS3_Old_OET %>% 
  rename(Old = ET) %>% 
  merge(WS3_Young_OET) %>% 
  rename(Young = ET) %>% 
  drop_na() %>% 
  mutate(Diff = Old - Young,
         DiffPer = 100 * (Old - Young)/Old)

#Total time series comparison
WS3_Comp_OET_TS <- WS3_Comp_OET %>% 
  ggplot(aes(x = DATE, y = Diff)) +
    geom_point() +
    xlab("DATE") + ylab("Diff ET (mm or %)") + ggtitle("WS3 Old ET - WS3 Young ET")

#Monthly comparison
WS3_Comp_OET_ByMonth <- WS3_Comp_OET %>% 
  mutate(Month = month(DATE)) %>% 
  group_by(Month) %>% 
  summarise(OldMon = mean(Old),
            YoungMon = mean(Young)) %>% 
  ungroup() %>% 
  mutate(DiffMon = OldMon - YoungMon,
         DiffPerMon = 100 * (OldMon - YoungMon)/OldMon) %>% 
  ggplot(aes(x = Month, y = DiffMon)) +
    geom_point() +
    xlab("Month") + ylab("Diff ET (mm or %)") + ggtitle("WS3 Old ET - WS3 Young ET")

#Plots
print(WS3_Comp_OET_TS)
ggplotly(WS3_Comp_OET_TS)
print(WS3_Comp_OET_ByMonth)
ggplotly(WS3_Comp_OET_ByMonth)

```
Add OpenET estimates to Figure 5 from HJA_figures. For the time being this is just to panel A bc scales are comparable
```{r OpenET2Figure5}
#Get mean daily from monthly estimates OpenET
# OET_Mean_Daily <- WS1_All_OET %>% 
#   drop_na() %>% 
#   mutate(Month = month(DATE)) %>% 
#   group_by(Month) %>% 
#   summarise(MeanMonthET = mean(ET)) %>% 
#   ungroup() %>% 
#   mutate(MeanDayET = MeanMonthET / 30) %>% 
#   filter(Month %in% 5:8)
# 
# Fig5Amod <- HillslopeTransDefPlot + geom_point(OET_Mean_Daily, mapping = aes(x = Month, y = MeanDayET))
# 
# print(Fig5Amod)

youngCol = "#4dac26"
oldCol = "#a6611a"
ripDefCol = "#01665e"
hillDefCol = "#80cdc1"
openETCol = "#bfbfbf"

myCols = c(c("Young" = youngCol, "Old" = oldCol, "HillDef" = hillDefCol, "RipDef" = ripDefCol, "ET_OET"))

myLineWidth = 2
myTxtSz = 20

#Put OpenET estimates in format so that it will display with sap flux estimates
WS1_All_OET_month <- WS1_All_OET %>% 
  filter(year(DATE) < 2023) %>% 
  mutate(Month = month(DATE)) %>% 
  group_by(Month) %>% 
  summarise(Mean_Month_ET = mean(ET)/30)

#Hillslope Transpiration Deficit with OpenET estimates on it
Fig5Amod <- TransDef %>% 
  select(DATE, transHillOld, transHillYoung, transDefHill) %>%
  mutate(ET_OpenET = 
    case_when(month(DATE) == 5 ~ WS1_All_OET_month$Mean_Month_ET[5],
              month(DATE) == 6 ~ WS1_All_OET_month$Mean_Month_ET[6],
              month(DATE) == 7 ~ WS1_All_OET_month$Mean_Month_ET[7],
              month(DATE) == 8 ~ WS1_All_OET_month$Mean_Month_ET[8],
              TRUE ~ 0)) %>% 
  ggplot() +
  geom_area(aes(x = DATE, y = transHillYoung, fill = "Young"),
            alpha = 0.3) +
  geom_area(aes(x = DATE, y = transHillOld, fill = "Old"),
            alpha = 0.3) +
  geom_area(aes(x = DATE, y = transDefHill, fill = "HillDef"),
            alpha = 0.7) +
  geom_area(aes(x = DATE, y = ET_OpenET, fill = "ET_OET"),
            alpha = 0.3) +
  theme_bw(base_size = myTxtSz) +
  scale_x_date(expand = c(0,0)) +
  labs(x = "", y = "Transpiration or ET (mm/d)") +
  scale_fill_manual(name = "", values = myCols)

print(Fig5Amod)
```









